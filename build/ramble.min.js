"use strict";var e={};e.Config={SITE_BASE_URL:"http://localhost:8000/",MEDIA_URL:"http://localhost:8000/data"};e.Util={pointsToLatLngs:function(e){var t,n=[];for(t in e)n.push(new L.LatLng(e[t].latitude,e[t].longitude));return n},videoURL:function(t){return e.Config.MEDIA_URL+"/"+t+"/"+t},createVideo:function(t){var n=document.createElement("video");n.autoplay=!1;n.canPlayType("video/webm")?n.src=e.Util.videoURL(t)+".webm":n.canPlayType("video/mp4")?n.src=e.Util.videoURL(t)+".mp4":n.canPlayType("video/ogg")?n.src=e.Util.videoURL(t)+".ogg":n.innerHTML=e.ERROR_CANNOT_PLAY_TYPE;n.controls="controls";return n},ERROR_CANNOT_PLAY_TYPE:"Sorry, your browser cannot play HTML5 Video. Please try using <a href='http://google.com/chrome'>Google Chrome</a> for best results",ERROR_NOT_VIDEO:"This method can only be called on video typed rambles.",ERROR_NOT_PHOTO:"This method can only be called on photo typed rambles."};e.Marker=L.Marker.extend({_reset:function(){var e=this._map.latLngToLayerPoint(this._latlng).round();L.DomUtil.setPosition(this._icon,e);this._shadow&&(this._shadow.style.display="none");if(this.options.iconAngle){this._icon.style.WebkitTransition="all .15s linear";this._icon.style.MozTransition="all .15s linear";this._icon.style.MsTransition="all .15s linear";this._icon.style.OTransition="all .15s linear";this._icon.style.WebkitTransform=this._icon.style.WebkitTransform+"translate(0px, 12px)  rotate("+this.options.iconAngle+"deg)";this._icon.style.MozTransform="translate(0px, 12px) rotate("+this.options.iconAngle+"deg)";this._icon.style.MsTransform="translate(0px, 12px) rotate("+this.options.iconAngle+"deg)";this._icon.style.OTransform="translate(0px, 12px) rotate("+this.options.iconAngle+"deg)"}this._icon.style.zIndex=e.y},_zoomAnimation:function(e){var t=this._map._latLngToNewLayerPoint(this._latlng,e.zoom,e.center);this._setPos(t)},_setPos:function(e){L.DomUtil.setPosition(this._icon,e);this._shadow&&L.DomUtil.setPosition(this._shadow,e);if(this.options.iconAngle){this._icon.style.WebkitTransition="all .15s linear";this._icon.style.MozTransition="all .15s linear";this._icon.style.MsTransition="all .15s linear";this._icon.style.OTransition="all .15s linear";this._icon.style.WebkitTransform=this._icon.style.WebkitTransform+"translate(0px, 12px)  rotate("+this.options.iconAngle+"deg)";this._icon.style.MozTransform="translate(0px, 12px) rotate("+this.options.iconAngle+"deg)";this._icon.style.MsTransform="translate(0px, 12px) rotate("+this.options.iconAngle+"deg)";this._icon.style.OTransform="translate(0px, 12px) rotate("+this.options.iconAngle+"deg)"}this._icon.style.zIndex=e.y+this.options.zIndexOffset},setIconAngle:function(e){this.options.iconAngle=e||0;this._map&&this._reset()},getIconAngle:function(){return this.options.iconAngle||0},setLatLng:function(e){this._latlng=e;this._reset();this._popup&&this._popup.setLatLng(e)}});e.Popup=L.Popup.extend({_initLayout:function(){var e,t,n="strabo-popup",r=this._container=L.DomUtil.create("div",n+" "+this.options.className+" strabo-zoom-animated");if(this.options.closeButton){e=this._closeButton=L.DomUtil.create("a",n+"-close-button",r);e.href="#close";L.DomEvent.addListener(e,"click",this._onCloseButtonClick,this)}t=this._wrapper=L.DomUtil.create("div",n+"-content-wrapper",r);L.DomEvent.disableClickPropagation(t);this._contentNode=L.DomUtil.create("div",n+"-content",t);L.DomEvent.addListener(this._contentNode,"mousewheel",L.DomEvent.stopPropagation);this._tipContainer=L.DomUtil.create("div",n+"-tip-container",r);this._tip=L.DomUtil.create("div",n+"-tip",this._tipContainer)},_update:function(){if(!this._map)return;this._container.style.visibility="hidden";this._updateLayout();this._updatePosition();this._container.style.visibility="";this._adjustPan()}});e.Marker.include({openPopup:function(){if(this._popup&&this._map){this._popup.setLatLng(this._latlng);this._map.openPopup(this._popup)}return this},closePopup:function(){this._popup&&this._popup._close();return this},bindPopup:function(t,n){var r=this.options.icon.options.popupAnchor||new L.Point(0,0);n&&n.offset&&(r=r.add(n.offset));n=L.Util.extend({offset:r},n);this._popup||this.on("click",this.openPopup,this);this._popup=(new e.Popup(n,this)).setContent(t);return this},unbindPopup:function(){if(this._popup){this._popup=null;this.off("click",this.openPopup)}return this}});e.Ramble=function(e,t,n){this.fireEvent("constructed");this._listeners={};e||this.error("Map parameter cannot be undefined.");t||this.error("rambleID parameter cannot be undefined.");this.id=t;this._options=n;this.map=e;this.MAP_WIDTH=e.getSize().x;this.MAP_HEIGHT=e.getSize().y;this._options=n||{};this.videoLoaded=!1;this.currentPoint=0;this.title="";this.latitude=0;this.longitude=0;this.heading=0;this.points=[];this.description="";this.token="";this.createdAt=null;this.uploadedAt=null;this.type=null;this.video=null;this.photo=null;this.start=null;this.marker=null;this.route=null;this.pull()};e.Ramble.prototype.pull=function(){var t,n;this.fireEvent("geodatapull");t=this;window.XMLHttpRequest?n=new XMLHttpRequest:window.ActiveXObject&&(n=new ActiveXObject("Microsoft.XMLHTTP"));n.onreadystatechange=function(){var i;if(n.readyState===4)if(n.status===200){i=JSON.parse(n.responseText);i=i.response;t.title=i.title;t.latitude=parseFloat(i.latitude);t.longitude=parseFloat(i.longitude);t.heading=parseFloat(i.heading);t.points=i.points;t.description=i.description;t.token=i.token;t.createdAt=i.created_at;t.uploadedAt=i.uploaded_at;t.type=i.type;t.start=new L.LatLng(t.latitude,t.longitude);t._latLngs=e.Util.pointsToLatLngs(t.points);t.marker=new e.Marker(t.start);t.marker.setIconAngle(Math.round(t.points[0].heading));t._latLngs.length>1&&(t.polyline=new L.Polyline(t._latLngs,{color:"#DB6C4D"}));t.show();if(t.type=="video"){t.initializeVideoPopup();t.video.addEventListener("timeupdate",function(){t.updateMap();t.fireEvent("timeupdate")});t.video.addEventListener("ended",function(){t.reset();t.fireEvent("ended")});t.video.addEventListener("seeking",function(){t.syncVideo();t.fireEvent("seeking")});t.video.addEventListener("seeked",function(){t.syncVideo();t.fireEvent("seeked")});t.video.addEventListener("play",function(){t.fireEvent("play")});t.video.addEventListener("pause",function(){t.fireEvent("pause")})}else t.type=="photo"&&(t.photo=new Image);t.fireEvent("geodatapulled")}else t.error("There was a problem with the request.")};n.open("GET",e.Config.MEDIA_URL+"/"+t.id+"/"+t.id+".json");n.send()};e.Ramble.prototype.show=function(){this.polyline&&this.map.addLayer(this.polyline);this.map.addLayer(this.marker)};e.Ramble.prototype.hide=function(){this.polyline&&this.map.removeLayer(this.polyline);this.map.removeLayer(this.marker)};e.Ramble.prototype.initializeVideoPopup=function(){var t,n;if(this.type=="video"){t=document.createElement("div");n=document.createElement("div");n.setAttribute("class","video-popup-title");n.innerHTML=this.title;this.video=e.Util.createVideo(this.token);t.appendChild(n);t.appendChild(this.video);this.marker.bindPopup(t)}else this.error(e.Util.ERROR_NOT_VIDEO)};e.Ramble.prototype.updateMap=function(){var t,n;if(this.type=="video"&&this.points){n=this.video.currentTime;if(n>this.video.duration){this.error("wtf");this.currentPoint=0}else{this.currentPoint>=this.points.length&&(this.currentPoint=this.points.length-1);t=this.points[this.currentPoint].timestamp;while(n>t&&this.currentPoint<this.points.length-1){this.currentPoint++;t=this.points[this.currentPoint].timestamp}this.setCurrentPoint(this.currentPoint)}}else this.error(e.Util.ERROR_NOT_VIDEO)};e.Ramble.prototype.syncVideo=function(){if(this.video){this.getPointByTime(this.video.currentTime);this.setCurrentPoint(this.currentPoint)}else this.error(e.Util.ERROR_NOT_VIDEO)};e.Ramble.prototype.reset=function(){if(this.video){this.setCurrentTime(0);this.fireEvent("reset")}else this.error(e.Util.ERROR_NOT_VIDEO)};e.Ramble.prototype.getPointByTime=function(e,t,n){var r,i;t=t||0;n=n||this.points.length;r=parseInt((n+t)/2,10);i=n-t;i<=1||e==this.points[r].timestamp?this.currentPoint=r:e>this.points[r].timestamp?this.getPointByTime(e,r,n):e<this.points[r].timestamp&&this.getPointByTime(e,t,r)};e.Ramble.prototype.setCurrentPoint=function(t){var n,r,i;if(this.video&&this.marker){this.currentPoint=t;n=this.marker.getIconAngle();r=Math.round(this.points[this.currentPoint].heading);i=r-n;i>180&&(i-=360);this.marker.setIconAngle(n+i);this.marker.setLatLng(new L.LatLng(this.points[this.currentPoint].latitude,this.points[this.currentPoint].longitude))}else this.error(e.Util.ERROR_NOT_VIDEO)};e.Ramble.prototype.setCurrentTime=function(t){if(this.video){this.video.currentTime=0;this.getPointByTime(t);this.setCurrentPoint(this.currentPoint)}else this.error(e.Util.ERROR_NOT_VIDEO)};e.Ramble.prototype.closeTrack=function(){};e.Ramble.prototype.loadTrack=function(){};e.Ramble.prototype.play=function(){this.video?this.video.play():this.error(e.Util.ERROR_NOT_VIDEO)};e.Ramble.prototype.pause=function(){this.video?this.video.pause():this.error(e.Util.ERROR_NOT_VIDEO)};e.Ramble.prototype.playPause=function(){this.video?this.video.paused?this.play():this.pause():console.error(e.Util.ERROR_NOT_VIDEO)};e.Ramble.prototype.addEventListener=function(e,t,n){var r=this._events=this._events||{};r[e]=r[e]||[];r[e].push({action:t,context:n||this});return this};e.Ramble.prototype.hasEventListeners=function(e){var t="_events";return t in this&&e in this[t]&&this[t][e].length>0};e.Ramble.prototype.removeEventListener=function(e,t,n){var r,i,s;if(!this.hasEventListeners(e))return this;for(r=0,i=this._events,s=i[e].length;r<s;r++)if(i[e][r].action===t&&(!n||i[e][r].context===n)){i[e].splice(r,1);return this}return this};e.Ramble.prototype.fireEvent=function(e,t){var n,r,i,s;if(!this.hasEventListeners(e))return this;n=L.Util.extend({type:e,target:this},t);r=this._events[e].slice();for(i=0,s=r.length;i<s;i++)r[i].action.call(r[i].context||this,n);return this};e.Ramble.prototype.error=function(e){this.fireEvent(e,{text:e});console&&console.error(e)};